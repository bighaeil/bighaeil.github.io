---
title: "MySQL 스터디 3일차 - encryption"
categories:
    - db
    - mysql
    - encryption
last_modified_at: 2023-05-15T17:00:00
toc: true
---

데이터 압호화 스터디 진행한다

# 데이터 암호화

mysql 5.7 부터 지원되기 시작한 데이터 암호화 기능은 처음에는 데이터 파일에만 지원되다가 8.0부터 데이터 파일뿐 아니라 리두 로그나 언두 로그, 복제를 위한 바이너리 로그 등 모두 암호화 기능을 지원하게 되었다

암호화 기능은 데이터를 읽고 쓰기 지점에서 암호화 또는 복호화를 수행한다

즉 디스크 입출력(I/O 레이어) 이외의 부분에서 암호화 처리는 필요하지 않는다

이러한 방식을 TDE(Transparent Data Encryption) 또는 "Data Rest Encryption"이라고 한다

## 2단계 키 관리

mysql 서버의 TDE에서 암호화 키는 키링(KeyRing) 플러그인에 의해 관린된다

8.0 부터 지원되는 키링 플러그인은 다음과 같다

- keyring_file (커뮤니티 에디션)
- keyring_encrypted_file
- keyring_okv
- keyring_aws

위에서 keyring_file 만 커뮤니티 에디션에서 사용 가능하고 나머지는 엔터프라이즈 에디션에서 사용 가능하다

마스터 키를 관리하는 방법만 다를 뿐 내부적으로는 작동하는 방식은 동일하다

mysql 서버의 데이터 암호화는 마스터 키와 테이블스페이스 키(private key)를 가지고 있다

마스터 키는 암호화된 테이블을 생성할 때 해당 테이블에 사용할 임의의 테이블스페이스 키를 발급한다

이렇게 생성된 테이블스페이스 키는 해당 테이블에서 사용되며 해당 테이블이 삭제되지 전까지 변경되거나 삭제되지 않는다 하지만 이 키는 절대 mysql 서버 외부로 노출되지 않기 때문에 주기적으로 변경하지 않아도 보안상 문제가 없다

하지만 마스터 키는 외부의 파일로 관리하기 때문에 노출될 가능성이 있다 그래서 주기적으로 변경해야 한다

### 마스터키 변경

마스터 키를 변경하면 각 테이블은 테이블스페이스 키를 복호화한 다음 새로운 마스터 키로 다시 암호화한다 마스터 키가 변경되는 동안 테이블스페이스 키 자체와 데이터는 전혀 변경되지 않는다

이렇게 2단계 암호화를 사용하는 이유는 암호화 키 변경 과정에서 과도한 시스템 부하를 피하기 위함이다

## 암호화 성능

서버는 페이지를 읽는 과정에서 복호화 과정을 거치기 때문에 쿼리 처리 지연시간이 생긴다

디스크에 저장할 때는 페이지 저장을 백그라운드 스레드가 수행하기 때문에 쿼리 지연이 생기지 않지만

select, update, delete 명령은 변경하고자 하는 레코드를 버퍼 풀로 읽어와야 하기 때문에 지연이 발생한다

### 메모리 효율

AES(Advanced Encryption Standard) 암호화 알고리즘으로 암호화 할 때 평문의 길이가 짦으면 암호화 용량이 커질 수 있지만 데이터 페이지는 암호화 키보다 휠씬 크기 때문에 메모리 사용 효율이 떨어지지 않는다

### 압축과 암호화

mysql 서버는 압축과 암호화가 동시에 적용되면 압축을 먼저 실행하고 암호화를 적용한다

1. 일반적으로 암호화된 결과가 랜덤한 바이트 배열을 가지기 때문에 압축률을 상당히 떨어트린다 그래서 압축을 먼저한다
2. 테이블의 데이터 페이지는 복호화된 상태로 버퍼 풀에 저장되지만 압축된 데이터 페이지는 압축 또는 해제된 상태가 공존하기 때문에 압축이 먼저 실행되어야 한다

## 암호화와 복제

레플리카 서버는 소스 서버의 모든 데이터를 동기화 하지만 TDE를 이용한 암호화 사용 시 마스터키와 테이블스페이스 키까지 같지는 않다

결국 각자의 마스터 키와 테이블스페이스 키를 관리하여 사용한다

즉 실제 암호화된 파일은 서로 다르다

## keyring_file 플로그인

keyring_file 플러그인은 마스터 키를 디스크의 파일로 관리하는데 평문으로 저장된다 그래서 저장된 파일이 노출 위험이 있다

## 테이블 암호화

사용하는 keyring 플러그인만 다를 뿐 사용법은 동일하다

## 응용 프로그램 암호화와 비교

직접 암호화해서 mysql 서버에 저장하는 경우가 있는데 그러면 저장된 칼럼의 값이 이미 암호화된 것인지 여부를 mysql이 알 수 없다

그래서 해당 칼럼에 인덱스를 생성해도 인덱스 기능을 활용할 수 없다 mysql 서버는 이미 암호화된 값 기준으로 정렬하기 때문에 암호화된 전의 값을 기준으로 정렬할 수 없다

그래서 mysql 서버의 암호화 기능을 사용하는 것을 권장한다

## 테이블스페이스 이동

테이블스페이스만 이동하는 경우 목적지의 mysql 서버의 암화화 키가 다르기 때문에 테이블스페이스 export 도는 import 기능을 사용한다

TDE로 암호화된 테이블에 export를 실행하면 mysql 서버는 임시로 사용할 마스터 키를 발급해서 파일로 기록하고 테이블스페이스를 기존 마스터 키로 복호화한 후 임시로 발급한 마스터 키를 이용해 다시 암호화 한다 그래서 암호화된 테이블 데이터와 임시 마스터키 파일을 같이 관리한다

## 언두 로그 및 리두 로그 암호화

테이블 암호화를 적용해도 디스크로 저장되는 데이터만 암호화하기 때문에 서버 메모리에서는 편문으로 관리한다 그래서 리두 로그와 언두 로그, 복제를 위한 바이너리 로그는 평문으로 저장이 되었다 그러나 8.0.16부터 시스템 변수를 이용하여 리두 로그와 언두 로그를 암호화된 상태로 저장할 수 있게 개선되었다

## 바이너리 로그 암호화

위와 같은 이유로 바이너리 로그도 평문으로 저장된다 복제 멤버 간 네트워크 구간에도 바이너리 로그를 암호화하고자 한다면 SSL을 사용하면 된다

### 바이너리 로그 암호화 키

바이너리 로그와 릴레이 로그 파일의 데이터는 파일 키로 암호화해서 디스크로 저장하는데 이 키를 바이너리 로그 암호화 키라 한다

이 키는 마스터 키와 동일한 역할을 한다



