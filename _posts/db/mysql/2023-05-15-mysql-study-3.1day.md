---
title: "MySQL 스터디 3일차 - compression"
categories:
    - db
    - mysql
    - compression
last_modified_at: 2023-05-15T17:00:00
toc: true
---

mysql 스터디 3일차 이번 시간은 압축를 한다

# 압축 방식

mysql에서 사용 가능한 압축 방식으로는 크게 테이블 압축과 페이지 압축 2가지가 있다

결론부터 말하면 페이지 압축 방식은 잘 사용하지 않는데 각각의 특징을 알아보고 그 이유에 대해서 알아보자

## 페이지 압축

페이지 압축은 서버가 디스크에서 데이터 페이지를 읽어올 때 압축을 해제하고 저장할 때 페이지를 압축하는 방식을 말한다

그래서 mysql 서버 내부에서 압축 여부와 상관없이 투명하게 작동하게 된다

여기서 문제점은 압출 결과가 용량이 얼마나 될지 예측할 수 없기 때문에 하나의 테이블은 동일한 크기의 페이지를 사용해야 한다

그러기 위해 펀치 홀(Punch hole) 이라는 기능을 사용하는데 이는 특정 크기 만큼의 페이지를 사용할 때 실제 사용하는 공간과 사용하지 않는 펀치 홀 공간이 존재한다

문제는 이 펀치 홀 기능을 위해선 운영체제뿐 아니라 하드웨어 자체에서도 해당 기능을 지원해야 사용할 수 있다 그리고 파일 시스템 관련 명령어에서 펀치 홀을 지원하지 않는다 예를 들어 cp 명령을 했을 때 실제 데이터 크기에서 펀치 홀 크기가 추가될 수 있다

이런 이유로 페이지 압축은 많이 사용되지 않는다

## 테이블 압축

Innor 스토리지 엔진 내에서 테이블 단위로 데이터를 압축한다

운영체제나 하드웨어에 대한 제약이 없다

### 압축 테이블 생성

테이블 압축을 사용하기 위해 테이블에 별도의 테이블 스페이스를 사용한다

KEY_BLOCK_SIZE 옵션을 이용해 압축된 페이지의 타깃 크기를 명시해야 한다

### 압축 프로세스

데이터 페이지 크기가 16KB 이고 KEY_BLOCK_SIZE가 8KB 라고 했을 때 InnoDB 스토리지 엔진이 압축을 하는 방법은 다음과 같다

1. 16KB의 데이터를 압축
    1. 압축 결과가 8KB 이하면 그대로 디스크에 저장(압축 완료)
    2. 압축 결과가 8KB 초과면 원본 페이지를 스플릿해서 2개의 페이지에 8KB씩 저장
2. 나뉜 페이지 각각에 대해 1번 단계를 반복

즉 압축 결과의 KEY_BLOCK_SIZE 목표 사이즈를 잘못 설정하면 처리 성능이 떨어질 수 있다

### KEY_BLOCK_SIZE 사이즈 결정

즉 압축의 핵심은 KEY_BLOCK_SIZE의 사이즈를 결정하는 일이다

압축 겨로가가 페이지 보다 커서 스플릿하여 다시 압축하는 것을 압축 실패라고 한다면 일반적으로 압축 실패율이 3 ~ 5% 미만으로 유지할 수 있게 KEY_BLOCK_SIZE를 결정하는 것이 좋다

압축 실패율이 높으면 디스크로 기록되지 전에 압축하는 과정이 꽤 오래 걸린다고 예측할 수 있지만 그렇다고 압축 실패율이 높다고 해서 사용하지 말아야 한다는 것은 아니다
데이터가 한번 저장되고 자주 사용하지 않는다고 하면 오히려 압축률이 높으면 데이터 크기가 큰 폭으로 줄어들기 때문에 더 이득일 수 있다

### 압축된 페이지의 버퍼 풀 적재 및 사용

InnoDB 스토리지 엔진은 압축된 데이터를 버퍼 풀에 적재하여 사용한다 그러면 압축된 상태의 데이터와 압축이 해제된 상태의 데이터가 공존한다 그래서 이를 관리하기 위하여 LRU 리스트와 Unzip_LRU 리스트를 별도로 사용한다

문제는 버퍼 풀 공간을 이중으로 사용하기 때문에 메모리가 낭비된다

그래서 요청 패턴에 따라 적절히 처리한다

- 버퍼 풀 공간이 필요한 경우 압축된 페이지(LRU 리스트)는 유지하고 압축 해제된 페이지(Unzip_LRU)를 제거해서 버퍼 풀의 공간을 확보한다
- 압축된 데이터 페이지가 자주 사용되는 경우 압축 해제된 페이지를 유지하면서 압축 및 압축 해제 작업을 최소화 한다
- 압축된 데이터 페이지가 사용되지 않아 LRU 리스트에서 제거해야 하는 경우 Unzip_LRU 리스트에서도 함께 제거 한다

버퍼 풀에 압축 해제된 버전의 페이지를 적절히 유지하기 위해 어댑티브 알고리즘을 사용한다

- CPU 사용량이 높으면 Unzip_LRU 비율을 높임
- DISK IO 사용량이 높으면 Unzip_LRU 리스트 비율을 낮춤

### 테이블 압축 관련 설정

테이블 압축 관련 시스템 변수가 몇가지 있다 이는 압축 실패율을 낮추기 위해 필요한 튜닝을 제공한다
